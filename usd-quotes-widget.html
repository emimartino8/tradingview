<div class="usd-quotes-tab-wrap">
  <section id="cards" class="grid"></section>
  <div class="updated" id="updated">Cargando…</div>

  <script>
    // ==== Config ====
    const CURRENTVALUE_ENDPOINT = (tipo) => `https://dolarapi.com/v1/dolares/${tipo}`;
    // ArgentinaDatos: fecha con SLASHES YYYY/MM/DD
    const PREVIOUSVALUE_ENDPOINT = (tipo, ymdSlash) => `https://api.argentinadatos.com/v1/cotizaciones/dolares/${tipo}/${ymdSlash}`;

    // 5 minutes
    const REFRESH_MS = 300000;
    const MAX_LOOKBACK_DAYS = 10;

    const USD_TYPE = ['oficial', 'mayorista', 'blue', 'bolsa', 'contadoconliqui', 'cripto', 'tarjeta'];

    const USD_DISPLAY_NAME = {
      oficial: 'Dólar oficial',
      blue: 'Dólar blue',
      bolsa: 'Dólar MEP',
      contadoconliqui: 'Dólar CCL',
      mayorista: 'Dólar mayorista',
      tarjeta: 'Dólar tarjeta',
      cripto: 'Dólar cripto'
    };

    const $cards = document.getElementById('cards');
    const $upd = document.getElementById('updated');
    const refs = new Map();

    // ==== Utils ====
    const n = (x) => {
      const v = parseFloat(x);
      return Number.isFinite(v) ? v : null;
    };

    const fmtARS = (v) => Number.isFinite(v) ? '$ ' + v.toLocaleString('es-AR', { maximumFractionDigits: 2 }) : '—';

    const fmtDate24 = (d) =>
      new Date(d).toLocaleString('es-AR', { hour12: false, timeZone: 'America/Argentina/Buenos_Aires' });

    // Argentinadatos requiere YYYY/MM/DD
    const toYMD_slash = (date) => {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}/${m}/${d}`;
    };

    async function fetchJSON(url) {
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        console.error('fetchJSON error:', url, e);
        return null;
      }
    }

    async function getPreviousQuote(tipo, baseDate) {
      for (let i = 1; i <= MAX_LOOKBACK_DAYS; i++) {
        const dt = new Date(baseDate);
        dt.setDate(dt.getDate() - i);
        const ymdSlash = toYMD_slash(dt);
        const data = await fetchJSON(PREVIOUSVALUE_ENDPOINT(tipo, ymdSlash));
        // Esperamos objeto: { moneda, casa, fecha, compra, venta }
        if (data) {
          const compra = n(data.compra);
          const venta = n(data.venta);
          if (compra !== null || venta !== null) {
            return { compra, venta, date: data.fecha || ymdSlash };
          }
        }
      }
      return null;
    }

    // ==== UI ====
    function createCard(tipo) {
      const el = document.createElement('article');
      el.className = 'card';
      el.innerHTML = `
      <h3 class="title" id="${tipo}-title">${USD_DISPLAY_NAME[tipo] || tipo}</h3>
      <div class="row">
        <div>
          <span class="label">Compra</span>
          <span class="value" id="${tipo}-buy">—</span>
        </div>
        <div>
          <span class="label">Venta</span>
          <span class="value" id="${tipo}-sell">—</span>
          <span class="change" id="${tipo}-sell-change">—</span>
        </div>
      </div>
      <div class="gap" id="${tipo}-gap">Brecha con oficial: —</div>
    `;
      $cards.appendChild(el);
      refs.set(tipo, {
        buy: el.querySelector(`#${tipo}-buy`),
        sell: el.querySelector(`#${tipo}-sell`),
        sellChange: el.querySelector(`#${tipo}-sell-change`),
        gap: el.querySelector(`#${tipo}-gap`),
        title: el.querySelector(`#${tipo}-title`)
      });
    }

    function ensureCards() {
      $cards.innerHTML = '';
      refs.clear();
      USD_TYPE.forEach(createCard);
    }

    function setTrend(el, diff) {
      el.classList.toggle('up', diff > 0);
      el.classList.toggle('down', diff < 0);
      el.classList.toggle('flat', diff === 0);
    }

    function isObject(x) { return x && typeof x === 'object' && !Array.isArray(x); }

    // ==== Lógica principal ====
    async function load() {
      ensureCards();

      const baseDate = new Date();

      // Oficial primero para brecha
      const oficialNow = await fetchJSON(CURRENTVALUE_ENDPOINT('oficial'));
      const oficialVenta = isObject(oficialNow) ? n(oficialNow.venta) : null;

      await Promise.all(USD_TYPE.map(async (tipo) => {
        const r = refs.get(tipo);
        if (!r) return;

        // Actual
        const now = await fetchJSON(CURRENTVALUE_ENDPOINT(tipo));
        if (!isObject(now)) {
          console.warn('Sin datos actuales para', tipo, now);
          r.buy.textContent = '—';
          r.sell.textContent = '—';
          r.sellChange.textContent = '—';
          r.buy.className = 'value'; r.sell.className = 'value'; r.sellChange.className = 'change';
          return;
        }

        const nowCompra = n(now.compra);
        const nowVenta = n(now.venta);

        r.buy.textContent = fmtARS(nowCompra);
        r.sell.textContent = fmtARS(nowVenta);

        // Brecha vs oficial
        if (Number.isFinite(oficialVenta) && tipo !== 'oficial' && Number.isFinite(nowVenta)) {
          const g = ((nowVenta - oficialVenta) / oficialVenta) * 100;
          r.gap.textContent = `Brecha con oficial: ${g >= 0 ? '+' : ''}${g.toFixed(2)}%`;
        } else {
          r.gap.textContent = 'Brecha con oficial: —';
        }

        // Previo con fallback
        const prev = await getPreviousQuote(tipo, baseDate);
        const prevVenta = n(prev?.venta);

        // Variación por VENTA -> mostrar debajo del precio de venta
        if (Number.isFinite(nowVenta) && Number.isFinite(prevVenta)) {
          const diff = nowVenta - prevVenta;
          const pct = (diff / prevVenta) * 100;
          const arrow = diff > 0 ? '▲' : diff < 0 ? '▼' : '=';

          if (diff === 0) r.sellChange.textContent = `= 0.00%`;
          else r.sellChange.textContent = `${arrow} ${pct > 0 ? '+' : ''}${pct.toFixed(2)}%`;

          // Pintar compra/venta y el % según Δ de venta
          setTrend(r.buy, diff);
          setTrend(r.sell, diff);
          r.sellChange.classList.toggle('up', diff > 0);
          r.sellChange.classList.toggle('down', diff < 0);
          r.sellChange.classList.toggle('flat', diff === 0);
        } else {
          r.sellChange.textContent = '—';
          r.sellChange.removeAttribute('title');
          r.buy.classList.remove('up', 'down', 'flat');
          r.sell.classList.remove('up', 'down', 'flat');
          r.sellChange.classList.remove('up', 'down', 'flat');
        }
      }));

      $upd.textContent = `Última actualización: ${fmtDate24(new Date())}`;
    }

    (async () => {
      try { await load(); } catch (e) { console.error('load error', e); }
      setInterval(() => load().catch((e) => console.error('refresh error', e)), REFRESH_MS);
    })();
  </script>

</div>

<style>
  .usd-quotes-tab-wrap {
    padding: 20px;
    background: #2a2a2a;
    height: 100%;
    overflow: auto;
  }

  .updated {
    text-align: left;
    color: #bdbdbd;
    font-size: .9rem;
    margin-top: 20px;
  }

  .grid {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  }

  .card {
    background: #121212;
    border: 1px solid #333;
    border-radius: 0;
    padding: 10px;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    gap: 30px;
  }

  .title {
    font-weight: 700;
    font-size: 1.0rem;
    margin: 0;
    color: #bdbdbd;
  }

  .row {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
  }

  .row>div {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 90px;
  }

  .label {
    display: block;
    font-size: .8rem;
    color: #bdbdbd;
  }

  .value {
    color: #ffffff;
    display: block;
    font-size: 1.2rem;
    margin-top: 15px;
    line-height: 1.2;
  }

  .change {
    display: block;
    font-size: .8rem;
    margin-top: 15px;
    line-height: 1;
    color: #bdbdbd;
  }

  .value.up,
  .change.up {
    color: #4caf50;
  }

  .value.down,
  .change.down {
    color: #ef5350;
  }

  .value.flat {
  color: #ffffff;
  }

  .change.flat {
    color: #707070;
  }

  .gap {
    font-size: .85rem;
    color: #bdbdbd;
  }
</style>